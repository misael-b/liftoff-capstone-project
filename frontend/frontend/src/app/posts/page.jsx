"use client";
import React, { useEffect, useState } from "react";
import axios from "axios";
import Layout from '../layout'

function getAllPosts() {
    return axios.get("http://localhost:8080/list")

};



const handleSubmit = async (event) => {
    const token = JSON.parse(localStorage.getItem('user')).accessToken
    const AuthStr = 'Bearer '.concat(token);
    event.preventDefault();

    const payload = {
        id: event.target.id
    }
    try {
        axios.post("http://localhost:8080/ShoppingCart/add?Id=" + event.target.id
            , payload, {
                headers: {
                    accept: "*/*",
                    "Content-Type": "application/json",
                    Authorization: AuthStr
                },

            })
    } catch (e) {
        console.log("error", e);
    }
}



const page = () => {

    const [loading, setLoading] = useState(true);
    const [products, setProducts] = useState(null);
    const [domLoaded, setDomLoaded] = useState(false);
    const [nameSorter, setNameSorter] = useState(false);
    const [priceSorter, setPriceSorter] = useState(false)

    useEffect(() => {
        const fetchData = async () => {
            setDomLoaded(true);

            try {
                const response = await getAllPosts();
                setProducts(response.data);
            } catch (error) {
                console.log(error);
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    function HandleChangle(event) {
        const { name, value } = event.target
        if (value) {
            try {
                const sortResponce = axios.get("http://localhost:8080/list/" + value).then(
                    function (response) {
                        setProducts(response.data)
                    }
                )
            } catch (e) {
                console.log("error", e);
            }
        }

    }
    const handleView = async (event) => {
        event.preventDefault();

        localStorage.setItem('productId', event.target.id);
        window.location = '/product-info';
    }

    const handleNameChange = () => {
        if (nameSorter === false) {
            setNameSorter(true)
            axios.get("http://localhost:8080/list/name-asc").then(
                function (response) {
                    setProducts(response.data)
                }
            )
            
        } 
        else {
            setNameSorter(false)
            let sortResponce = axios.get("http://localhost:8080/list/name-desc").then(
                function (response) {
                    setProducts(response.data)
                }
            )
            
        } 
    }

    const handlePriceChange = () => {
        if (priceSorter === false) {
            setPriceSorter(true)
            axios.get("http://localhost:8080/list/asc").then(
                function (response) {
                    setProducts(response.data)
                }
            )

        }
        else {
            setPriceSorter(false)
            let sortResponce = axios.get("http://localhost:8080/list/desc").then(
                function (response) {
                    setProducts(response.data)
                }
            )

        }
    }


    return (
        <Layout>
            {domLoaded && (
            <div>
                <h1 style={{ margin: 50, fontSize:40}}>View All Posts</h1>

                <form>
                    <label> Sort by:
                        <select name="sortBy" onChange={HandleChangle}>
                            <option value="">*Select One*</option>
                            <option value="desc">Price (High-Low)</option>
                            <option value="asc">Price (Low-High)</option>
                            <option value="category-asc">Category (A-Z)</option>
                            <option value="name-asc">Name (A-Z)</option>

                        </select>

                    </label>

                    </form> <br /><br />




                <table width='100%'>
                    <thead>
                        <tr>
                            <th>
                                Picture
                            </th>
                            <th onClick={handleNameChange}>
                                Name
                            </th>
                            <th width='20%' >
                                Description
                            </th>
                            <th>
                                Category
                            </th>
                            <th onClick={handlePriceChange}>
                                Price
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    {!loading && (
                        <tbody>
                            {products.map((product) => (
                                <tr>
                                    <th><img src={product.picture} width={200} /></th>
                                    <th><a href="#" id={product.id} onClick={handleView}>{product.name}</a></th>
                                    <th>{product.description}</th>
                                    <th>{product.category}</th>
                                    <th> ${product.price}</th>
                                    <th>
                                        {localStorage.getItem('user') ? <form onSubmit={handleSubmit} id={product.id}>
                                            <button type="submit" class="buyButton"><span>Buy </span></button>
                                        </form> : <div><p><a href='http://localhost:3000/login' style={{ color: "blue" }}>Login</a> to purchage</p></div>}


                                    </th>

                                </tr>



                            ))}

                        </tbody>
                    )}
                </table>
                </div>
            )} 



        </Layout>
    )

    
 }

export default page